# Product Requirements Document (PRD)

**Project Name:** Checkmate Coach (Working Title)
**Version:** 1.0
**Date:** October 26, 2023
**Status:** Draft

---

## 1. Executive Summary

"Checkmate Coach" is a mobile and web-based chess application designed to bridge the gap between playing and learning. Unlike traditional apps that offer post-game analysis, this application utilizes a **real-time intervention system**. It pauses the game immediately when a user makes a suboptimal move, using a hybrid AI system (Stockfish for calculation + LLM for explanation) to teach the user *why* the move was a mistake and guide them through better alternatives before the game proceeds.

## 2. Problem Statement

* **The Feedback Gap:** Existing apps provide numeric evaluations (e.g., `-2.5`) which are abstract, or post-game analysis which lacks emotional context.
* **The "Why" Problem:** Engines show *where* to move but fail to explain *why* strategically in natural language.
* **Skill Plateaus:** Intermediate players (800–1500 ELO) often repeat the same mistakes because they don't receive immediate correction.

## 3. User Personas

* **The Improver (Primary):** ELO 800–1400. Wants to get better but finds studying books boring. Wants to learn by doing.
* **The Returner:** Former casual player coming back to the game. Needs a "safe" environment to practice without the stress of ranked PvP.

---

## 4. Functional Requirements

### 4.1 Game Setup

* **User Inputs:**
* **Target ELO:** User selects the difficulty of the opponent (e.g., 800, 1000, 1200, 1500).
* **Coach Strictness:** User selects intervention threshold:
* *Strict:* Intervenes on inaccuracies (0.5+ pawn loss).
* *Standard:* Intervenes on mistakes (1.5+ pawn loss).
* *Forgiving:* Intervenes only on blunders (3.0+ pawn loss).


* **Side Selection:** White, Black, or Random.



### 4.2 The Chess Engine (Maia2 Neural Network)

* **Technology:** Maia2 model served locally via Flask (`backend/model_server.py`, port 5000).
* **Responsibility:**
1. Act as the opponent (tuned to the selected ELO via `elo_self` / `elo_oppo` parameters).
2. Provide win probability for the current position.
3. Identify the best move and provide probability distributions over all legal moves.



### 4.3 The Intervention Trigger (Core Feature)

* **Logic:** Upon User Move, compare win probability before and after the move.
* **Action:**
* If win probability drop is below threshold: Game continues normally. Maia2 replies.
* If win probability drop exceeds threshold: **GAME PAUSES.** The move is tentatively placed on the board but highlighted (e.g., Orange/Red border). The "Coach Modal" is triggered.



### 4.4 The Coach Interaction (LLM Integration)

* **Trigger:** When the game pauses, the app sends a payload to the LLM API.
* **Display:** A conversational interface (modal or bottom sheet) appears over the board.
* **Content:**
* **Head:** "Hold on! That move gives up your advantage."
* **Body:** A natural language explanation of the tactical error (generated by LLM).
* **Interactive Element:** "See the better line."



### 4.5 The "Ghost Line" Visualization

* **Analysis Mode:** When the user chooses to see the better line, the board enters "Ghost Mode."
* **Visuals:**
* The user's mistake is faded out.
* The Engine's best move is shown with a **Green Ghost Piece** or Arrow.
* **Auto-Play:** The board automatically animates the next 3 moves (The Principal Variation) to show the user the resulting advantage (e.g., winning a piece).


* **Resolution:** User clicks "Got it." The board resets to the position *before* the mistake. User must try a different move to proceed.

---

## 5. Technical Architecture (The Hybrid Model)

### 5.1 Client-Side (Device)

* **Responsibilities:** Rendering board, User Input, Intervention Trigger.
* **Reasoning:** The Maia2 model runs on a local server with fast inference (~100ms on CPU), keeping latency low for move evaluation.

### 5.2 Server-Side (Local + Cloud)

* **Local:** Maia2 model server for move prediction and win probability.
* **Cloud:** LLM API (GPT-4o / GPT-4o-Mini) for natural language explanations.

### 5.3 Data Pipeline (The "Narrator" Prompt)

When an intervention triggers, the client sends this JSON to the Server:

```json
{
  "fen": "r1bqkbnr/pppp1ppp/... (Board State)",
  "user_move": "h3",
  "maia2_data": {
    "win_prob_before": 0.58,
    "win_prob_after": 0.34,
    "best_move": "g1f3",
    "move_probabilities": { "g1f3": 0.22, "d2d4": 0.18, "h2h3": 0.03 }
  }
}

```

**System Prompt Logic:**

> "You are a chess coach. The user played `h3` which dropped their win probability from 58% to 34%. The Maia2 model recommends `Nf3` (22% probability among all moves — the top choice). Explain to an amateur player why h3 is too passive and narrate how Nf3 fights for the center. Keep it under 50 words."

---

## 6. UX/UI Guidelines

### 6.1 Board Interface

* Minimalist, distraction-free.
* Clear distinction between "Real Pieces" (Opacity 100%) and "Ghost/Future Pieces" (Opacity 50% or distinct color stroke).

### 6.2 The "Pause" Moment

* Must not feel jarring (like an error message).
* **Animation:** The board dims slightly, the Coach Avatar slides up from the bottom.
* **Tone:** Helpful, not scolding. "Wait, check this out," rather than "Wrong move."

---

## 7. Success Metrics (KPIs)

* **Intervention Acceptance:** % of times a user plays the *suggested* best move after an intervention.
* **Session Length:** Number of games played per session.
* **Retention:** D30 retention rate (Does the coaching actually feel valuable?).
* **Latency:** Time between "Bad Move" and "Explanation Text" appearing (Target: <2.5 seconds).

---

## 8. Roadmap

### Phase 1: MVP (Month 1-2)

* Single Player vs. AI.
* Basic Stockfish integration.
* Intervention Logic.
* Text-based LLM explanations.

### Phase 2: Enhanced Learning (Month 3)

* Voice Mode (Text-to-Speech for the Coach).
* "Review My Game" (Post-game summary).

### Phase 3: Monetization (Month 4)

* Subscription gates for "Grandmaster Model" (GPT-4o) vs "Club Model" (GPT-4o-Mini).

---

## 9. Riskiest Assumptions & Mitigations

| Risk | Impact | Mitigation |
| --- | --- | --- |
| **LLM Hallucination** | High. Coach gives wrong advice. | **Strict Rule:** LLM never calculates moves. It only *narrates* the moves Stockfish provides in the prompt. |
| **Latency** | Medium. User gets bored waiting for explanation. | **Async Loading:** Show the "Ghost Moves" immediately (client-side) while the LLM text is generating in the background. |
| **Cost** | High. Active users drain API credits. | **Tiered Models:** Use cheaper models for free users; limit SOTA models to paid tier. |